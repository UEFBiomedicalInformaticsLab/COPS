---
title: "Introduction to COPS"
author: "Teemu Rintala and Vittorio Fortino"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Introduction to COPS}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

<style type="text/css">

body{ /* Normal  */
      font-size: 12px;
  }
td {  /* Table  */
  font-size: 10px;
}
h1.title {
  font-size: 30px;
  color: DarkRed;
}
h1 { /* Header 1 */
  font-size: 24px;
  color: DarkBlue;
}
h2 { /* Header 2 */
    font-size: 20px;
  color: DarkBlue;
}
h3 { /* Header 3 */
  font-size: 15px;
  font-family: "Times New Roman", Times, serif;
  color: DarkBlue;
}
code.r{ /* Code block */
    font-size: 10px;
}
pre { /* Code block - determines code spacing between lines */
    font-size: 10px;
}
</style>

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

## Patient stratification and disease subtype discovery

The R package COPS provides a suite of feature reduction techniques and clustering algorithms for disease subtype discovery from single or multiple omics data. 

This notebook covers single-view clustering. 

**Single-omics tools provided by COPS**
* Knowledge-driven feature extraction: GSVA, DiffRank, RWR-FGSEA
* Dimensional reduction: PCA, t-SNE, UMAP
* Single-omics clustering algorithms: k-means++, agglomerative hierarchical clustering, DIANA, Gaussian Mixture Models (GMMs), kernel k-means, knn graph community detection

**Multi-omics tools provided by COPS**
* Joint dimensionality reduction: MOFA2, IntNMF
* Multi-omics clustering algorithms: ANF, iCluster(+/Bayes), IntNMF, Multiple Kernel K-Means with Matrix induced Regularization (MKKM-MR)

**Performance metrics provided by COPS** 
* External metrics: clinical variable associations (ANOVA, NMI, ARI, Jaccard), Survival analysis
* Internal metrics: clustering stability, silhouette, gene module correlation
* batch effect analysis: chi-squared test rejection rate, batch associations (ARI, NMI), kBET

```{r setup, message = FALSE}
library(COPS)
library(swamp)
```

## 1. How to perform cluster analysis using COPS

Example starting from a pre-processed data matrix and batch label vector. In this example we use the included Atopic Dermatitis (*ad_ge_micro_zscore*) data set and its annotations *ad_studies*. 

```{r pipeline, cache.lazy = TRUE, echo = TRUE, message = FALSE}
results <- COPS(list(ad = ad_ge_micro_zscore), 
                association_data = ad_studies, 
                include_original = FALSE, 
                parallel = 2, 
                nruns = 2, 
                nfolds = 5, 
                dimred_methods = c("pca", "umap", "tsne"),
                cluster_methods = c("hierarchical", "kmeans"),
                distance_metric = "euclidean", 
                n_clusters = 2:4)
scores <- clusteval_scoring(results)

# List 10 best scores
scores$all[1:10,]
```
```{r, cache.lazy = TRUE, echo = TRUE, message = FALSE}
# Generate embedding and clustering based on best setting
best <- get_best_result(results, scores)
```

### Plot study and cluster associations in best embedding using swamp
```{r figure1, fig.height = 6, fig.width = 6, fig.align = "center", warning = FALSE}
swamp::confounding(data.frame(best$embedding[,grepl("^dim[0-9]+", colnames(best$embedding))], 
                              clusters = factor(best$clusters$cluster), 
                              ad_studies))
```

### More associations in best embedding
```{r ca_embedding}
embedding_associations(t(as.matrix(best$embedding[,grepl("^dim[0-9]+", colnames(best$embedding))])), 
                       cbind(clust = best$clusters$cluster, study = ad_studies))
```

### Associations in original data
```{r ca_original}
embedding_associations(ad_ge_micro_zscore,
                       cbind(clust = best$clusters$cluster, study = ad_studies))
```



